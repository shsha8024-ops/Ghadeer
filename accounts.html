<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الحسابات - Ghadeer Logistics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary:#cc3300;
      --primary-dark:#a32900;
      --accent:#ffd166;
      --bg:#f2f4f8;
      --card:#ffffff;
      --text:#1a1d23;
      --muted:#6b7280;
      --radius:18px;
      font-family:'Cairo',sans-serif;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,#fef2f2 0%,#f2f4f8 55%,#eef2ff 100%);
      color:var(--text);
    }
    .page {
      max-width:1200px;
      margin:0 auto;
      padding:32px 20px 60px;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:20px;
      margin-bottom:32px;
      flex-wrap:wrap;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:16px;
    }
    .brand img {
      width:58px;
      height:58px;
      border-radius:50%;
      object-fit:cover;
      box-shadow:0 8px 16px rgba(204,51,0,0.18);
    }
    h1 {
      font-size:28px;
      margin:0;
      color:var(--primary);
    }
    header p {
      margin:4px 0 0;
      color:var(--muted);
    }
    .quick-actions {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    button, input, select, textarea {
      font-family:inherit;
    }
    .btn {
      border:none;
      padding:12px 20px;
      border-radius:12px;
      font-size:15px;
      cursor:pointer;
      font-weight:600;
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn-primary {
      background:var(--primary);
      color:#fff;
      box-shadow:0 8px 18px rgba(204,51,0,0.22);
    }
    .btn-primary:hover { background:var(--primary-dark); transform:translateY(-1px); }
    .btn-secondary {
      background:#fff;
      color:var(--primary);
      border:1px solid rgba(204,51,0,0.25);
    }
    .summary-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:20px;
      margin-bottom:32px;
    }
    .summary-card {
      background:var(--card);
      border-radius:var(--radius);
      padding:22px 24px;
      box-shadow:0 20px 35px rgba(15,23,42,0.08);
      position:relative;
      overflow:hidden;
    }
    .summary-card::after {
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top right, rgba(204,51,0,0.12), transparent 60%);
      pointer-events:none;
    }
    .summary-card h3 {
      margin:0;
      font-size:15px;
      color:var(--muted);
    }
    .summary-card strong {
      display:block;
      margin-top:10px;
      font-size:28px;
    }
    .summary-card span {
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--primary);
      margin-top:12px;
      font-size:14px;
    }
    .workspace {
      display:grid;
      grid-template-columns:2.2fr 1fr;
      gap:24px;
    }
    @media (max-width:1024px) {
      .workspace { grid-template-columns:1fr; }
    }
    .panel {
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:0 18px 30px rgba(15,23,42,0.08);
    }
    .panel h2 {
      margin:0 0 18px;
      font-size:20px;
      color:var(--primary);
    }
    .filters {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:20px;
    }
    .filters input, .filters select {
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #d6d8df;
      flex:1;
      min-width:180px;
      font-size:14px;
      background:#f9fafc;
    }
    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      box-shadow:0 14px 28px rgba(15,23,42,0.05);
    }
    thead {
      background:#fff5f0;
      color:var(--primary);
    }
    th, td {
      padding:16px 18px;
      text-align:center;
      font-size:14px;
      border-bottom:1px solid #f0f1f5;
      background:#fff;
    }
    tbody tr:hover td { background:#fff9f5; }
    tbody tr:last-child td { border-bottom:none; }
    .tag {
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      background:#fff5f0;
      color:var(--primary);
      font-size:13px;
    }
    .note-pill {
      display:inline-flex;
      align-items:center;
      max-width:180px;
      padding:6px 12px;
      border-radius:12px;
      background:#eef2ff;
      color:#1d4ed8;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .actions {
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .action-btn {
      padding:9px 14px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition:all .2s ease;
      color:#fff;
    }
    .action-btn.view { background:#0f766e; }
    .action-btn.view:hover { background:#0d5f59; }
    .action-btn.edit { background:#d97706; }
    .action-btn.edit:hover { background:#b45309; }
    .action-btn.delete { background:#dc2626; }
    .action-btn.delete:hover { background:#b91c1c; }
    .empty-state {
      text-align:center;
      padding:46px 20px;
      color:var(--muted);
    }
    form label { display:block; margin-bottom:6px; font-weight:600; }
    form input, form textarea {
      width:100%;
      border:1px solid #d8dae5;
      border-radius:14px;
      padding:12px 14px;
      font-size:14px;
      margin-bottom:14px;
      background:#f9fafc;
      transition:border .2s ease, box-shadow .2s ease;
    }
    form input:focus, form textarea:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(204,51,0,0.15);
    }
    textarea { resize:vertical; min-height:90px; }
    .aside {
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .list-card {
      background:var(--card);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:0 18px 30px rgba(15,23,42,0.08);
    }
    .list-card h3 {
      margin:0 0 18px;
      font-size:18px;
      color:var(--primary);
    }
    .top-clients {
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .top-clients li {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      background:#fff6f2;
      border-radius:14px;
      font-size:14px;
    }
    .top-clients span { color:var(--muted); }
    .notes textarea { min-height:120px; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <img src="your-logo.jpeg" alt="Ghadeer Logistics logo">
        <div>
          <h1>لوحة تحكم الحسابات</h1>
          <p>متابعة مالية كاملة لعملاء Ghadeer Logistics</p>
        </div>
      </div>
      <div class="quick-actions">
        <button class="btn btn-secondary" type="button" id="seedData">تحميل بيانات تجريبية</button>
        <button class="btn btn-primary" type="button" onclick="exportCSV()">تصدير تقرير CSV</button>
      </div>
    </header>

    <section class="summary-grid">
      <article class="summary-card">
        <h3>عدد العملاء النشطين</h3>
        <strong id="metricClients">0</strong>
        <span>👥 عملاء موثقون</span>
      </article>
      <article class="summary-card">
        <h3>إجمالي الفواتير</h3>
        <strong id="metricInvoices">0</strong>
        <span>📑 فواتير مسجلة</span>
      </article>
      <article class="summary-card">
        <h3>إجمالي المبالغ</h3>
        <strong id="metricAmount">0</strong>
        <span>💰 ريال سعودي</span>
      </article>
      <article class="summary-card">
        <h3>متوسط قيمة الفاتورة</h3>
        <strong id="metricAverage">0</strong>
        <span>⚖️ مؤشر متوسط</span>
      </article>
    </section>

    <div class="workspace">
      <section class="panel">
        <h2>إدارة العملاء والفواتير</h2>
        <div class="filters">
          <input type="text" id="search" placeholder="🔍 بحث باسم العميل...">
          <select id="sort">
            <option value="">↕️ ترتيب افتراضي</option>
            <option value="nameAsc">🔤 الاسم (أ-ي)</option>
            <option value="nameDesc">🔤 الاسم (ي-أ)</option>
            <option value="invoices">📑 حسب عدد الفواتير</option>
            <option value="total">💰 حسب أعلى مبلغ</option>
          </select>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>العميل</th>
                <th>عدد الفواتير</th>
                <th>إجمالي المبالغ</th>
                <th>ملاحظات</th>
                <th>خيارات</th>
              </tr>
            </thead>
            <tbody id="clients"></tbody>
          </table>
          <div class="empty-state" id="emptyState" hidden>
            لا توجد بيانات بعد. ابدأ بإضافة عملاء أو حمّل بيانات تجريبية.
          </div>
        </div>
      </section>

      <aside class="aside">
        <section class="panel">
          <h2>إضافة عميل جديد</h2>
          <form id="clientForm">
            <label for="clientName">اسم العميل</label>
            <input type="text" id="clientName" placeholder="أدخل اسم العميل" required>

            <label for="clientNotes">ملاحظات إضافية</label>
            <textarea id="clientNotes" placeholder="أكتب نبذة عن العميل أو طبيعة التعامل"></textarea>

            <button class="btn btn-primary" type="submit">➕ إضافة العميل</button>
          </form>
        </section>

        <section class="list-card">
          <h3>أعلى العملاء حسب الإيراد</h3>
          <ul class="top-clients" id="topClients">
            <li>لا يوجد بيانات بعد<span>--</span></li>
          </ul>
        </section>

        <section class="list-card notes">
          <h3>ملاحظات الفريق</h3>
          <textarea placeholder="دوّن ملاحظاتك السريعة حول الحسابات..." id="teamNotes"></textarea>
        </section>
      </aside>
    </div>
  </div>

  <script>
    let accounts = JSON.parse(localStorage.getItem("accounts")) || {};
    const notesKey = "accounts-notes";
    const clientNotesKey = "client-notes-map";
    let clientNotesMap = JSON.parse(localStorage.getItem(clientNotesKey)) || {};

    const searchInput = document.getElementById("search");
    const sortSelect = document.getElementById("sort");
    const clientsBody = document.getElementById("clients");
    const emptyState = document.getElementById("emptyState");
    const topClientsList = document.getElementById("topClients");
    const teamNotes = document.getElementById("teamNotes");

    teamNotes.value = localStorage.getItem(notesKey) || "";
    teamNotes.addEventListener("input", () => {
      localStorage.setItem(notesKey, teamNotes.value);
    });

    document.getElementById("clientForm").addEventListener("submit", addClient);
    searchInput.addEventListener("input", render);
    sortSelect.addEventListener("change", render);
    document.getElementById("seedData").addEventListener("click", seedDemoData);

    function render(){
      clientsBody.innerHTML = "";
      const query = searchInput.value.trim();
      let clients = Object.keys(accounts);

      if(query){
        clients = clients.filter(name => name.includes(query));
      }

      const sortValue = sortSelect.value;
      clients.sort((a,b) => {
        if(sortValue === "nameAsc") return a.localeCompare(b);
        if(sortValue === "nameDesc") return b.localeCompare(a);
        if(sortValue === "invoices") return accounts[b].length - accounts[a].length;
        if(sortValue === "total"){
          const totalA = totalAmountFor(a);
          const totalB = totalAmountFor(b);
          return totalB - totalA;
        }
        return 0;
      });

      if(clients.length === 0){
        emptyState.hidden = false;
      } else {
        emptyState.hidden = true;
      }

      for(const client of clients){
        const invoices = accounts[client];
        const total = totalAmountFor(client);
        const note = clientNotesMap[client];
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${client}</strong></td>
          <td><span class="tag">${invoices.length}</span></td>
          <td>${formatCurrency(total)}</td>
          <td>${note ? `<span class="note-pill" title="${note}">${notePreview(note)}</span>` : "--"}</td>
          <td>
            <div class="actions">
              <button class="action-btn view" onclick="viewClient('${client}')">عرض</button>
              <button class="action-btn edit" onclick="editClient('${client}')">تعديل</button>
              <button class="action-btn delete" onclick="deleteClient('${client}')">حذف</button>
            </div>
          </td>`;
        clientsBody.appendChild(tr);
      }

      updateMetrics();
      renderTopClients();
    }

    function addClient(event){
      event.preventDefault();
      const name = document.getElementById("clientName").value.trim();
      if(!name) return;
      const noteValue = document.getElementById("clientNotes").value.trim();
      if(!accounts[name]){
        accounts[name] = [];
      }
      if(noteValue){
        clientNotesMap[name] = noteValue;
      } else if(clientNotesMap[name]){
        delete clientNotesMap[name];
      }
      localStorage.setItem("accounts", JSON.stringify(accounts));
      localStorage.setItem(clientNotesKey, JSON.stringify(clientNotesMap));
      event.target.reset();
      render();
    }

    function viewClient(name){
      window.location.href = "client.html?name=" + encodeURIComponent(name);
    }

    function editClient(oldName){
      const newName = prompt("أدخل الاسم الجديد للعميل:", oldName);
      if(newName && newName !== oldName){
        accounts[newName] = accounts[oldName];
        delete accounts[oldName];
        if(clientNotesMap[oldName]){
          clientNotesMap[newName] = clientNotesMap[oldName];
          delete clientNotesMap[oldName];
        }
        localStorage.setItem("accounts", JSON.stringify(accounts));
        localStorage.setItem(clientNotesKey, JSON.stringify(clientNotesMap));
        render();
      }
    }

    function deleteClient(name){
      if(confirm("هل تريد حذف العميل " + name + " وجميع بياناته؟")){
        delete accounts[name];
        if(clientNotesMap[name]){
          delete clientNotesMap[name];
          localStorage.setItem(clientNotesKey, JSON.stringify(clientNotesMap));
        }
        localStorage.setItem("accounts", JSON.stringify(accounts));
        render();
      }
    }

    function exportCSV(){
      const rows = [["العميل","عدد الفواتير","إجمالي المبالغ","ملاحظات"]];
      for(const client in accounts){
        const invoices = accounts[client];
        const total = invoices.reduce((sum, invoice) => sum + Number(invoice.price || 0), 0);
        const note = clientNotesMap[client] ? clientNotesMap[client].replace(/\n/g, " ") : "";
        rows.push([client, invoices.length, total, note]);
      }
      const csvContent = rows.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "accounts-report.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function totalAmountFor(client){
      return accounts[client].reduce((sum, invoice) => sum + Number(invoice.price || 0), 0);
    }

    function formatCurrency(value){
      return Number(value || 0).toLocaleString("ar-SA", { style:"currency", currency:"SAR" });
    }

    function updateMetrics(){
      const clientCount = Object.keys(accounts).length;
      let invoiceCount = 0;
      let totalAmount = 0;
      for(const client in accounts){
        const invoices = accounts[client];
        invoiceCount += invoices.length;
        totalAmount += invoices.reduce((sum, invoice) => sum + Number(invoice.price || 0), 0);
      }
      const average = invoiceCount ? totalAmount / invoiceCount : 0;
      document.getElementById("metricClients").textContent = clientCount.toLocaleString("ar-SA");
      document.getElementById("metricInvoices").textContent = invoiceCount.toLocaleString("ar-SA");
      document.getElementById("metricAmount").textContent = formatCurrency(totalAmount);
      document.getElementById("metricAverage").textContent = formatCurrency(average);
    }

    function renderTopClients(){
      const entries = Object.entries(accounts).map(([name, invoices]) => {
        return { name, total: invoices.reduce((sum, invoice) => sum + Number(invoice.price || 0), 0) };
      }).filter(item => item.total > 0);
      entries.sort((a,b) => b.total - a.total);
      topClientsList.innerHTML = "";
      if(entries.length === 0){
        const li = document.createElement("li");
        li.innerHTML = "لا يوجد بيانات بعد<span>--</span>";
        topClientsList.appendChild(li);
        return;
      }
      for(const item of entries.slice(0,5)){
        const li = document.createElement("li");
        li.innerHTML = `<strong>${item.name}</strong><span>${formatCurrency(item.total)}</span>`;
        topClientsList.appendChild(li);
      }
    }

    function seedDemoData(){
      accounts = {
        "شركة شمال البحر": [
          { invoice:"INV-001", price: 4200 },
          { invoice:"INV-014", price: 3600 },
          { invoice:"INV-028", price: 6900 }
        ],
        "مؤسسة الميناء الحديث": [
          { invoice:"INV-004", price: 1800 },
          { invoice:"INV-051", price: 2400 }
        ],
        "تحالف الخليج اللوجستي": [
          { invoice:"INV-019", price: 9500 },
          { invoice:"INV-121", price: 7200 },
          { invoice:"INV-177", price: 5300 },
          { invoice:"INV-190", price: 2800 }
        ],
        "حلول النور للملاحة": [
          { invoice:"INV-031", price: 3100 }
        ],
        "شركة المسار الذكي": [
          { invoice:"INV-211", price: 8700 },
          { invoice:"INV-212", price: 6500 }
        ]
      };
      clientNotesMap = {
        "شركة شمال البحر": "عميل استراتيجي مع شحنات شهرية ثابتة.",
        "مؤسسة الميناء الحديث": "يحتاج لتقارير أسبوعية تفصيلية.",
        "تحالف الخليج اللوجستي": "أكبر عميل من ناحية حجم الشحنات.",
        "حلول النور للملاحة": "عميل جديد قيد المتابعة.",
        "شركة المسار الذكي": "يتم الدفع بآلية تحويل بنكي كل 10 أيام."
      };
      localStorage.setItem("accounts", JSON.stringify(accounts));
      localStorage.setItem(clientNotesKey, JSON.stringify(clientNotesMap));
      render();
    }

    function notePreview(note){
      if(note.length <= 22) return note;
      return note.slice(0, 22) + "...";
    }

    render();
  </script>
</body>
</html>
